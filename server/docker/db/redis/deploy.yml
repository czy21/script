version: '3.9'

x-redis-common: &redis-common
  image: redis:6.2.6-alpine
  privileged: true
  user: root
  environment:
    TZ: Asia/Shanghai
  restart: always

services:
  redis:
    <<: *redis-common
    container_name: redis
    ports:
      - "{{ param_db_redis_port }}:6379"
    volumes:
      - {{ param_docker_data }}/{{ param_role_name }}/conf/redis.conf:/etc/redis/redis.conf
      - {{ param_docker_data }}/{{ param_role_name }}/data/single/:/data/
    command: redis-server /etc/redis/redis.conf

  {% for i in range(param_db_redis_cluster_replicas | int) %}
    {% set j = i + 1 %}
    {% set p = (param_db_redis_cluster_start_port | int) + i %}
  redis{{ j }}:
    <<: *redis-common
    container_name: redis{{ j }}
    ports:
      - "{{ p }}:{{ p }}"
      - "1{{ p }}:1{{ p }}"
    volumes:
      - {{ param_docker_data }}/{{ param_role_name }}/conf/redis.conf:/etc/redis/redis.conf
      - {{ param_docker_data }}/{{ param_role_name }}/data/{{ j }}/:/data/
    command: redis-server /etc/redis/redis.conf --port {{ p }} --cluster-enabled yes --cluster-announce-ip {{ param_db_redis_cluster_ip }}
  {% endfor %}

  redis-exporter-{{ param_db_redis_port }}:
    image: oliver006/redis_exporter:alpine
    container_name: redis-exporter-{{ param_db_redis_port }}
    user: root
    command:
      - --redis.addr=redis://{{ param_db_redis_password }}@{{ param_db_redis_host }}:{{ param_db_redis_port }}
    environment:
      REDIS_EXPORTER_IS_CLUSTER: "false"
    restart: always

  redis-exporter-{{ param_db_redis_cluster_start_port }}:
    image: oliver006/redis_exporter:alpine
    container_name: redis-exporter-{{ param_db_redis_cluster_start_port }}
    user: root
    command:
      - --redis.addr=redis://{{ param_db_redis_password }}@{{ param_db_redis_host }}:{{ param_db_redis_cluster_start_port }}
    environment:
      REDIS_EXPORTER_IS_CLUSTER: "true"
    restart: always

networks:
  default:
    external:
      name: local
