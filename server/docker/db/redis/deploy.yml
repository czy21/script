version: '3.9'

x-redis-common: &redis-common
  image: redis/redis-stack-server
  privileged: true
  user: root
  environment:
    TZ: Asia/Shanghai
  restart: always

services:
  {% if param_db_redis_standalone_enabled == true %}
  redis:
    <<: *redis-common
    container_name: redis
    ports:
      - "{{ param_db_redis_port }}:6379"
    volumes:
      - {{ param_docker_data }}/{{ param_role_name }}/data/single/:/data/
    environment:
      REDIS_ARGS: |-
        --requirepass {{ param_db_redis_password }}
        --appendonly yes
  redis-exporter-{{ param_db_redis_port }}:
    image: oliver006/redis_exporter:alpine
    container_name: redis-exporter-{{ param_db_redis_port }}
    user: root
    command:
      - --redis.addr=redis://{{ param_db_redis_host }}:{{ param_db_redis_port }}
      - --redis.password={{ param_db_redis_password }}
    environment:
      REDIS_EXPORTER_IS_CLUSTER: "false"
    restart: always
  {% endif %}
  {% for i in range(param_db_redis_cluster_replicas | int) %}
    {% set j = i + 1 %}
    {% set p = (param_db_redis_cluster_start_port | int) + i %}
  redis{{ j }}:
    <<: *redis-common
    container_name: redis{{ j }}
    ports:
      - "{{ p }}:{{ p }}"
      - "1{{ p }}:1{{ p }}"
    volumes:
      - {{ param_docker_data }}/{{ param_role_name }}/data/{{ j }}/:/data/
    environment:
      REDIS_ARGS: |-
        --port {{ p }}
        --requirepass {{ param_db_redis_password }}
        --appendonly yes
        --cluster-enabled yes
        --cluster-announce-ip {{ param_db_redis_cluster_ip }}
  {% endfor %}

  redis-exporter-{{ param_db_redis_cluster_start_port }}:
    image: oliver006/redis_exporter:alpine
    container_name: redis-exporter-{{ param_db_redis_cluster_start_port }}
    user: root
    command:
      - --redis.addr=redis://{{ param_db_redis_host }}:{{ param_db_redis_cluster_start_port }}
      - --redis.password={{ param_db_redis_password }}
    environment:
      REDIS_EXPORTER_IS_CLUSTER: "true"
    restart: always


