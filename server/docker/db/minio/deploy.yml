version: '3.9'

x-minio-common: &minio-common
  image: {{ param_registry_proxy_url | default("quay.io") }}/minio/minio
  privileged: true
  user: root
  expose:
    - "9000"
    - "9001"
  environment:
    MINIO_ROOT_USER: {{ param_db_minio_username }}
    MINIO_ROOT_PASSWORD: {{ param_db_minio_password }}
    MINIO_PROMETHEUS_AUTH_TYPE: public
  restart: always

services:
{% if param_db_minio_mode == "standalone" %}
  minio:
    <<: *minio-common
    container_name: minio
    volumes:
      - {{ param_docker_data }}/{{ param_role_name }}/data/:/data/
    command: server /data --console-address ":9001"
{% elif param_db_minio_mode == "cluster" %}
  {% for i in range(param_db_minio_cluster_replicas | int) %}
    {% set i=i+1 %}
  minio{{ i }}:
    <<: *minio-common
    container_name: minio{{ i }}
    volumes:
      - {{ param_docker_data }}/{{ param_role_name }}/data/default:/data/
      {% for j in range(param_db_minio_cluster_drives | int) %}
        {% set j=j+1 %}
      - {{ param_docker_data }}/{{ param_role_name }}/data/{{ i }}-{{ j }}:/data{{ j }}
      {% endfor %}
    command: server --console-address ":9001" http://minio{1...{{ param_db_minio_cluster_replicas }}}/data{1...{{ param_db_minio_cluster_drives }}}
  {% endfor %}
{% endif %}

networks:
  default:
    external:
      name: local