version: "3.9"

{% set kb_name = param_db_es_cluster_name + '-kb' %}

x-es-common: &es-common
  image: {{ param_registry_proxy_url | default("docker.elastic.co") }}/elasticsearch/elasticsearch:7.17.4
  restart: always
  ulimits:
    memlock:
      soft: -1
      hard: -1

x-traefik-kb-label: &traefik-kb-label
  traefik.enable: true
  traefik.http.routers.{{ kb_name }}.rule: Host(`kibana-nas.cluster.com`)
  traefik.http.routers.{{ kb_name }}.service: {{ kb_name }}
  traefik.http.services.{{ kb_name }}.loadbalancer.server.port: 5601

x-traefik-es-label: &traefik-es-label
  traefik.enable: true
  traefik.http.routers.{{ param_db_es_cluster_name }}.rule: Host(`es-nas.cluster.com`)
  traefik.http.routers.{{ param_db_es_cluster_name }}.service: {{ param_db_es_cluster_name }}
  traefik.http.services.{{ param_db_es_cluster_name }}.loadbalancer.server.port: 9200

services:
  init-{{ param_db_es_cluster_name }}:
    container_name: init-{{ param_db_es_cluster_name }}
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.4
    command: |
      bash -c '
        if [[ ! -f /cert/bundle.zip ]]; then
          bin/elasticsearch-certutil cert --silent --pem --in config/instance.yml -out /cert/bundle.zip;
          unzip /cert/bundle.zip -d /cert; 
        fi;
        chown -R 1000:0 /cert
        rm -rf /cert/bundle.zip
      '
    user: "0"
    working_dir: /usr/share/elasticsearch
    volumes:
      - {{ param_docker_data }}/{{ param_db_es_cluster_name }}/cert/:/cert/
      - {{ param_docker_data }}/{{ param_db_es_cluster_name }}/conf/instance.yml/:/usr/share/elasticsearch/config/instance.yml
  {% for i in range(1,param_db_es_cluster_replicas | int + 1) %}
    {% set es_node_name = param_db_es_cluster_name + '-' + i | string %}
  {{ es_node_name }}:
    <<: *es-common
    container_name: {{ es_node_name }}
    hostname: {{ es_node_name }}
    labels:
      <<: *traefik-es-label
    expose:
      - "9200"
    environment:
      node.name: {{ es_node_name }}
      cluster.name: {{ param_db_es_cluster_name }}
      {% set seed_hosts=[] %}
      {% set initial_master_nodes=[] %}
      {% for t in range(1,param_db_es_cluster_replicas | int + 1) %}
         {% set t_es_node_name = param_db_es_cluster_name + '-' + t | string %}
        {% if t_es_node_name != es_node_name %}
          {{ seed_hosts.append(t_es_node_name) or ''}}
        {% endif %}
        {{ initial_master_nodes.append(t_es_node_name) or ''}}
      {% endfor %}
      discovery.seed_hosts: {{ seed_hosts | join(',') }}
      cluster.initial_master_nodes: {{ initial_master_nodes | join(',') }}
      bootstrap.memory_lock: "true"
      ES_JAVA_OPTS: -Xms512m -Xmx512m
      ELASTIC_PASSWORD: {{ param_db_es_password }}
      {% set cert_dir='/usr/share/elasticsearch/config/cert' %}
      xpack.license.self_generated.type: trial
      xpack.security.enabled: true
      xpack.security.http.ssl.enabled: false
      xpack.security.transport.ssl.enabled: true
      xpack.security.transport.ssl.verification_mode: certificate
      xpack.security.transport.ssl.certificate_authorities: {{ cert_dir }}/ca/ca.crt
      xpack.security.transport.ssl.certificate: {{ cert_dir }}/{{ es_node_name }}/{{ es_node_name }}.crt
      xpack.security.transport.ssl.key: {{ cert_dir }}/{{ es_node_name }}/{{ es_node_name }}.key
    volumes:
      - {{ param_docker_data }}/{{ param_db_es_cluster_name }}/data/{{ i }}:/usr/share/elasticsearch/data
      - {{ param_docker_data }}/{{ param_db_es_cluster_name }}/cert/:/usr/share/elasticsearch/config/cert/
    depends_on:
      - init-{{ param_db_es_cluster_name }}
  {{ kb_name }}:
    image: {{ param_registry_proxy_url | default("docker.elastic.co") }}/kibana/kibana:7.17.4
    container_name: {{ kb_name }}
    labels:
      <<: *traefik-kb-label
    expose:
      - "5601"
    volumes:
      - {{ param_docker_data }}/{{ param_db_es_cluster_name }}/conf/kibana.yml:/usr/share/kibana/config/kibana.yml
    restart: always
  {% endfor %}
