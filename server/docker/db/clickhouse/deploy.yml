version: "3.9"

x-common: &common
  image: clickhouse/clickhouse-server:22.8

services:
  {%- for i in range(1,param_db_clickhouse_cluster_replicas | int + 1) %}
  {{ param_role_name }}-{{ i }}:
    <<: *common
    container_name: {{ param_role_name }}-{{ i }}
    expose:
      - "8123"
      - "9000"
      - "9009"
      - "9004"
    ports:
      - '{{ (param_db_clickhouse_cluster_start_port | int) + i-1 }}:8123'
    volumes:
      - '{{ param_docker_data }}/{{ param_role_name }}/conf/config.xml:/etc/clickhouse-server/config.d/config.xml'
      - '{{ param_docker_data }}/{{ param_role_name }}/conf/users.xml:/etc/clickhouse-server/users.d/users.xml'
      - '{{ param_docker_data }}/{{ param_role_name }}/data/{{ i }}:/var/lib/clickhouse/'
      - '{{ param_docker_data }}/{{ param_role_name }}/data/{{ i }}/data/:/var/lib/clickhouse/data/'
      - '{{ param_docker_data }}/{{ param_role_name }}/log/{{ i }}:/var/log/'
    environment:
      CLICKHOUSE_DB: default
      CLICKHOUSE_USER: {{ param_db_clickhouse_username }}
      CLICKHOUSE_PASSWORD: {{ param_db_clickhouse_password }}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
  {%- endfor %}