version: '3.9'

services:
  {% for i in range(1,param_db_zk_cluster_replicas | int + 1) %}
  zk{{ i }}:
    image: zookeeper
    container_name: zk{{ i }}
    ports:
      - 218{{ i }}:2181
    volumes:
      - {{ param_docker_data }}/{{ param_role_name }}/data/{{ i }}:/data/
      - {{ param_docker_data }}/{{ param_role_name }}/datalog/{{ i }}:/datalog/
      - {{ param_docker_data }}/{{ param_role_name }}/logs/{{ i }}:/logs/
    environment:
      ZOO_MY_ID: {{ i }}
      ZOO_TICK_TIME: 60000
      {% set zk_servers=[] %}
      {% for t in range(1,param_db_zk_cluster_replicas | int + 1) %}
        {% set server="" %}
        {% if t == i %}
          {% set server="0.0.0.0" %}
        {% else %}
          {% set server="zk{0}".format(t | string) %}
        {% endif %}
        {{ zk_servers.append("server.{0}={1}:2888:3888;2181".format(t|string,server)) or '' }}
      {% endfor %}
      ZOO_SERVERS: {{ zk_servers | join(' ') }}
    restart: always
  {% endfor %}

networks:
  default:
    external:
      name: local
