- name: prune
  hosts: all
  remote_user: opsor
  become: yes
  tasks:
    - name: calico prune
      shell: nmcli d status | grep "^cali\|^tun" | awk '{print $1}' | xargs nmcli device delete -
    - name: docker login prune
      shell: rm -rf $HOME/.docker --force
    - name: docker container prune
      shell: docker container prune --force
    - name: docker volume prune
      shell: docker volume prune --force
    - name: docker image prune
      shell: docker image prune --all --force
    - name: docker network prune
      shell: docker network prune --force
    - name: reinstall docker-compose
      shell: rm -rf /usr/local/bin/docker-compose && yum -y install docker-compose-plugin
  tags:
    - prune

- name: machine
  hosts: all
  remote_user: opsor
  vars_files:
    - "vars/main.yml"
  become: yes
  vars:
    param_users: 
      - root
      - opsor
  tasks:
    - name: passwd -d
      shell: passwd -d {{item}}
      with_items: '{{param_users}}'

    - name: restart docker
      shell: systemctl daemon-reload;systemctl restart docker

    - name: machine reboot
      shell: reboot

    - name: machine shutdown
      shell: shutdown -h now

    - name: replace docker mirror
      shell: sudo sed -i.bak -e "s,^baseurl=https://download.docker.com/linux,baseurl=http://{{ param_mirror_yum }},g" /etc/yum.repos.d/docker-ce.repo

    - name: reinstall docker-compose
      shell: |-
        sudo curl -L "https://github.com/docker/compose/releases/download/v2.5.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose
        sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
    - name: switch yum mirror
      shell: |-
        #sed -i.bak -e "s,^mirrorlist=,#mirrorlist=,g" -e "s,^#baseurl=,baseurl=,g" -e "s,^baseurl=http://mirror.centos.org/\$contentdir,baseurl=http://nexus.cluster.com/repository/yum-proxy-centos,g" /etc/yum.repos.d/CentOS-*.repo
        yum clean all && yum makecache

  tags:
    - machine
