- name: k8s
  become: yes
  import_tasks: install.yml
  tags:
    - '{{ param_role_name }}'

- name: hosts init
  become: yes
  shell: sudo cat {{ param_remote_role_path }}/hosts-{{ ansible_distribution | lower}} > /etc/hosts
  tags:
    - 'k8s-init'

- name: master init
  become: yes
  shell: |-
    sudo kubeadm init --config {{ param_remote_role_path }}/k8s-config.yml
    sudo -i eval 'if [ -z ${KUBECONFIG} ];then echo 'export KUBECONFIG=/etc/kubernetes/admin.conf' >> ~/.bashrc; fi;'
    sudo -u {{ param_user_ops }} bash -c "set -e;cd;mkdir -p .kube && sudo cp --force /etc/kubernetes/admin.conf .kube/config && sudo chown {{ param_user_ops }}:{{ param_user_ops }} .kube/config"
  when: "'master' in group_names"
  tags:
    - 'k8s-init'

- name: worker join
  become: yes
  shell: kubeadm join 192.168.2.25:6443 --token 1nk6u8.rx29jnazce7k2bdv --discovery-token-ca-cert-hash sha256:8697700c2ce96f42f04c80db32937a3c9ed0b621dfe4be3ed9c139d30c8c20fc
  when: "'worker' in group_names"
  tags:
    - 'k8s-join'

- name: master backup
  become: yes
  shell: echo 'backup'
  when: "'master' in group_names"
  tags:
    - 'k8s-backup'

- name: master restore
  become: yes
  shell: echo 'restore'
  when: "'master' in group_names"
  tags:
    - 'k8s-restore'