- name: hosts init
  become: yes
  shell: |
    sudo cat {{ param_remote_role_path }}/hosts-init-{{ ansible_distribution | lower}} > /etc/hosts

- name: crictl install
  become: yes
  shell: |
    sudo wget -c https://github.com/kubernetes-sigs/cri-tools/releases/download/v{{ param_k8s_version }}/crictl-v{{ param_k8s_version }}-linux-amd64.tar.gz -O - | sudo tar -xz -C /usr/local/bin
    sudo chown root:root /usr/local/bin/crictl && sudo chmod +x /usr/local/bin/crictl
    sudo ln -sf /usr/local/bin/crictl /usr/bin/crictl

- name: crio install
  become: yes
  shell: |
    sudo mkdir -p /etc/containers/
    sudo cat {{ param_remote_role_path }}/crio-init-registries.conf > /etc/containers/registries.conf
    bash {{ param_remote_role_path }}/crio-install-{{ ansible_distribution | lower}}.sh
    sudo sed -i.bak \
    -e 's|registry.k8s.io|{{ param_registry_proxy_url }}|g' \ 
    -e 's|^# \(pause_image = \)|\1|g' /etc/crio/crio.conf
    sudo systemctl daemon-reload && sudo systemctl restart crio && sudo systemctl enable crio

- name: k8s install
  become: yes
  shell: |
    sudo cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
    overlay
    br_netfilter
    EOF

    sudo cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
    net.bridge.bridge-nf-call-iptables  = 1
    net.bridge.bridge-nf-call-ip6tables = 1
    net.ipv4.ip_forward                 = 1
    EOF
    
    sudo sysctl --system
    bash {{ param_remote_role_path }}/k8s-install-{{ ansible_distribution | lower}}.sh && kubectl completion bash | sudo tee /etc/bash_completion.d/kubectl > /dev/null

- name: helm install
  become: yes
  shell: |
    sudo wget -O - https://get.helm.sh/helm-v3.9.0-linux-amd64.tar.gz | sudo tar -zxf - --strip-components 1 -C /usr/local/bin/ linux-amd64/helm
    sudo chown root:root /usr/local/bin/helm && sudo chmod +x /usr/local/bin/helm
    sudo ln -sf /usr/local/bin/helm /usr/bin/helm
    helm completion bash | sudo tee /etc/bash_completion.d/helm > /dev/null