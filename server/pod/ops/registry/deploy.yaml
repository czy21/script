apiVersion: v1
kind: Service
metadata:
  name: registry
spec:
  selector:
    app: registry
  type: NodePort
  ports:
    - name: "5000"
      port: 5000
      targetPort: 5000
      nodePort: 5000
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: registry
  labels:
    app: registry
data:
  htpasswd: |
    admin:$2y$05$sr2aoCHGy0R.9QhDDNOiFevSE2J.gisKTdk/aYKS1nbX69XPThC8a
  registry.key: |
    -----BEGIN PRIVATE KEY-----
    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
    Czcs1VVR7NyqoGfUZR9epSbzUcfG93k=
    -----END PRIVATE KEY-----
  registry.crt: |
    -----BEGIN CERTIFICATE-----
    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
    -----END CERTIFICATE-----


---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: registry
spec:
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: registry
  template:
    metadata:
      labels:
        app: registry
    spec:
      volumes:
        - name: auth
          configMap:
            name: registry
            items:
              - key: "htpasswd"
                path: "htpasswd"
        - name: cert
          configMap:
            name: registry
            items:
              - key: "registry.crt"
                path: "registry.crt"
              - key: "registry.key"
                path: "registry.key"
        - name: data
          persistentVolumeClaim:
            claimName: data-registry
      containers:
        - name: registry
          image: registry:2
          ports:
            - containerPort: 5000
          env:
            - name: REGISTRY_AUTH
              value: htpasswd
            - name: REGISTRY_AUTH_HTPASSWD_REALM
              value: Registry Realm
            - name: REGISTRY_AUTH_HTPASSWD_PATH
              value: /auth/htpasswd
            - name: REGISTRY_HTTP_TLS_CERTIFICATE
              value: /certs/registry.crt
            - name: REGISTRY_HTTP_TLS_KEY
              value: /certs/registry.key
          volumeMounts:
            - name: cert
              mountPath: /certs/
            - name: auth
              mountPath: /auth/
            - name: data
              mountPath: /var/lib/registry/
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: data-registry
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 256Gi
  storageClassName: "managed-nfs-storage"
