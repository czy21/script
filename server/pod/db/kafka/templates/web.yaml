---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: '{{ .Release.Name }}-web'
  namespace: '{{ .Release.Namespace }}'
spec:
  selector:
    matchLabels:
      app: '{{ .Release.Name }}-web'
  template:
    metadata:
      labels:
        app: '{{ .Release.Name }}-web'
    spec:
      volumes:
      - name: conf
        configMap:
          name: '{{ .Release.Name }}-web'
          items:
          - key: system-config.properties
            path: system-config.properties
      containers:
        - name: '{{ .Release.Name }}-web'
          image: {{ .Values.registry.url }}/{{ .Values.registry.dir }}/kafka-web
          args:
          - /bin/bash
          - -c
          - 'ke.sh start && trap : TERM INT; sleep infinity & wait'
          imagePullPolicy: Always
          ports:
            - containerPort: 8048
          volumeMounts:
          - name: conf
            mountPath: /opt/kafka-eagle/conf/
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: '{{ .Release.Name }}-web'
  namespace: '{{ .Release.Namespace }}'
  labels:
    app: '{{ .Release.Name }}-web'
data:
  system-config.properties: |-
    ######################################
    # multi zookeeper & kafka cluster list
    # Settings prefixed with 'kafka.eagle.' will be deprecated, use 'efak.' instead
    ######################################
    efak.zk.cluster.alias=cluster1
    cluster1.zk.list={{ .Values.zk.connect }}

    ######################################
    # zookeeper enable acl
    ######################################
    cluster1.zk.acl.enable=false
    cluster1.zk.acl.schema=digest
    cluster1.zk.acl.username=test
    cluster1.zk.acl.password=test123

    ######################################
    # broker size online list
    ######################################
    cluster1.efak.broker.size=20

    ######################################
    # zk client thread limit
    ######################################
    kafka.zk.limit.size=32

    ######################################
    # EFAK webui port
    ######################################
    efak.webui.port=8048

    ######################################
    # kafka jmx acl and ssl authenticate
    ######################################
    cluster1.efak.jmx.acl=false
    cluster1.efak.jmx.user=keadmin
    cluster1.efak.jmx.password=keadmin123
    cluster1.efak.jmx.ssl=false
    cluster1.efak.jmx.truststore.location=/data/ssl/certificates/kafka.truststore
    cluster1.efak.jmx.truststore.password=ke123456

    ######################################
    # kafka offset storage
    ######################################
    cluster1.efak.offset.storage=kafka

    ######################################
    # kafka jmx uri
    ######################################
    cluster1.efak.jmx.uri=service:jmx:rmi:///jndi/rmi://%s/jmxrmi

    ######################################
    # kafka metrics, 15 days by default
    ######################################
    efak.metrics.charts=true
    efak.metrics.retain=15

    ######################################
    # kafka sql topic records max
    ######################################
    efak.sql.topic.records.max=5000
    efak.sql.topic.preview.records.max=10

    ######################################
    # delete kafka topic token
    ######################################
    efak.topic.token=keadmin

    ######################################
    # kafka sasl authenticate
    ######################################
    cluster1.efak.sasl.enable=false
    cluster1.efak.sasl.protocol=SASL_PLAINTEXT
    cluster1.efak.sasl.mechanism=SCRAM-SHA-256
    cluster1.efak.sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required username="kafka" password="kafka-eagle";
    cluster1.efak.sasl.client.id=
    cluster1.efak.blacklist.topics=
    cluster1.efak.sasl.cgroup.enable=false
    cluster1.efak.sasl.cgroup.topics=


    ######################################
    # kafka sqlite jdbc driver address
    ######################################
    efak.driver=org.sqlite.JDBC
    efak.url=jdbc:sqlite:/opt/kafka-eagle/db/ke.db
    efak.username=root
    efak.password=www.kafka-eagle.org

    ######################################
    # kafka mysql jdbc driver address
    ######################################
    #efak.driver=com.mysql.cj.jdbc.Driver
    #efak.url=jdbc:mysql://127.0.0.1:3306/ke?useUnicode=true&characterEncoding=UTF-8&zeroDateTimeBehavior=convertToNull
    #efak.username=root
    #efak.password=123456

