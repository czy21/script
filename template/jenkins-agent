pipeline{
  agent {
    kubernetes {
        cloud 'dev'
        yaml '''
          apiVersion: v1
          kind: Pod
          spec:
            volumes:
            - name: docker-sock
              hostPath:
                path: /var/run/docker.sock
            - name: docker-cmd
              hostPath:
                path: /usr/bin/docker
            - name: kubectl
              hostPath:
                path: /bin/kubectl
            containers:
            - name: jnlp
              image: 'registry.cluster2.com/library/jenkins-agent'
              securityContext:
                runAsUser: 0
              volumeMounts:
              - name: docker-sock
                mountPath: /var/run/docker.sock
              - name: docker-cmd
                mountPath: /usr/bin/docker
              - name: kubectl
                mountPath: /bin/kubectl
    '''
    }
  }
  environment {
    KUBE_CONFIG = 'kube-config-dev'
    KUBE_SERVER = 'https://192.168.2.21:6443'
    HELM_REPO   = 'http://nexus.cluster2.com/repository/helm/'
    RELEASE_TEMPLATE = 'java-template'
    RELEASE_NAMESPACE = 'erp'
    RELEASE_NAME = 'portal'
    RELEASE_VERSION = 'dev-bruce'
  }
  stages{
    stage('deploy') {
      steps {
        script {
            script {
                def helm, k8s
                fileLoader.withGit('git@gitee.com:czyhome/script.git', 'master', 'bruce', '') {
                    helm = fileLoader.load('groovy/helm.groovy');
                    k8s = fileLoader.load('groovy/k8s.groovy');
                }
                helm.templateRender();
                k8s.apply();
            }
        }
      }
    }
  }
}