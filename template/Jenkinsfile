node{
    GRADLE_HOME = "/var/jenkins_home/tools/gradle-7.1"
    env.PATH = "${GRADLE_HOME}/bin:${env.PATH}"
    env.GRADLE_HOME = "${GRADLE_HOME}"
    env.BRANCH_NAME="dev-bruce"
    env.PROJECT_ROOT="${WORKSPACE}/code/api"
    env.PROJECT_MODULE="portal"
    stage('clone'){
        script {
            checkout([$class: 'GitSCM', branches: [[name: "${BRANCH_NAME}"]], extensions: [[$class: 'SubmoduleOption', disableSubmodules: false, parentCredentials: true, recursiveSubmodules: true, reference: '', trackingSubmodules: false]], userRemoteConfigs: [[credentialsId: 'bruce', url: 'git@gitee.com:czyhome/erp.git']]])
        }
    }
    stage('build'){
        sh 'chmod +x ${PROJECT_ROOT}/gradlew && ${PROJECT_ROOT}/gradlew --init-script ${GRADLE_HOME}/init.d/init.gradle --build-file ${PROJECT_ROOT}/build.gradle ${PROJECT_MODULE}:clean ${PROJECT_MODULE}:build -x test'
        sh 'docker build --tag registry:5000/${PROJECT_MODULE}:${BRANCH_NAME} --file ${PROJECT_ROOT}/${PROJECT_MODULE}/Dockerfile ${PROJECT_ROOT}/${PROJECT_MODULE}/ --no-cache --force-rm'
        sh 'docker push registry:5000/${PROJECT_MODULE}:${BRANCH_NAME}'
    }
}